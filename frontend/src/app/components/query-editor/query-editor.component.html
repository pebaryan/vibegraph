<div class="query-editor-container">
  <h2>SPARQL Query Editor</h2>
  <div class="editor-layout">
    <aside class="editor-sidebar">
      <mat-accordion>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>LLM Assistant</mat-panel-title>
            <mat-panel-description>Generate & repair SPARQL</mat-panel-description>
          </mat-expansion-panel-header>
          <div class="llm-panel">
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Ask in plain English</mat-label>
              <textarea
                matInput
                rows="4"
                [formControl]="questionCtrl"
                placeholder="e.g. List all classes and their counts"
              ></textarea>
            </mat-form-field>
            <mat-form-field appearance="fill" style="width: 100%">
              <mat-label>Graph</mat-label>
              <mat-select [(value)]="selectedGraphId">
                <mat-option *ngFor="let g of graphs" [value]="g.graph_id">
                  {{ g.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-checkbox [formControl]="autoRepairCtrl">
              Auto‑repair on error
            </mat-checkbox>
            <div class="llm-actions">
              <button
                mat-raised-button
                color="primary"
                (click)="generateFromQuestion()"
                [disabled]="generating"
              >
                {{ generating ? "Generating…" : "Generate SPARQL" }}
              </button>
              <button
                mat-stroked-button
                color="primary"
                (click)="repairQuery()"
                [disabled]="repairing"
              >
                {{ repairing ? "Repairing…" : "Repair Last Error" }}
              </button>
            </div>
          </div>
        </mat-expansion-panel>
      </mat-accordion>

      <mat-card class="sidebar-card">
        <mat-card-title>Templates</mat-card-title>
        <mat-card-content>
          <button
            mat-stroked-button
            color="primary"
            class="sidebar-button"
            *ngFor="let t of templates"
            (click)="insertTemplate(t.query)"
          >
            {{ t.name }}
          </button>
        </mat-card-content>
      </mat-card>

      <mat-card class="sidebar-card">
        <mat-card-title>Prefixes</mat-card-title>
        <mat-card-content>
          <button
            mat-stroked-button
            color="primary"
            class="sidebar-button"
            (click)="insertAllPrefixes()"
            [disabled]="!prefixes.length"
          >
            Insert All Prefixes
          </button>
          <div class="prefix-list">
            <button
              mat-button
              class="prefix-item"
              *ngFor="let p of prefixes"
              (click)="insertPrefix(p)"
              [title]="p.prefix + ': <' + p.uri + '>'"
            >
              {{ p.prefix }}
            </button>
          </div>
        </mat-card-content>
      </mat-card>
    </aside>

    <section class="editor-main">
      <div class="editor-panel">
        <ngx-monaco-editor
          [options]="editorOptions"
          [(ngModel)]="query"
          class="editor"
        ></ngx-monaco-editor>
      </div>
      <div class="editor-actions">
        <button
          mat-raised-button
          color="primary"
          (click)="execute()"
          [disabled]="loading || !query"
        >
          Execute
        </button>
        <mat-form-field class="history-field">
          <mat-label>Query History</mat-label>
          <mat-select [(value)]="selectedHistory">
            <mat-option *ngFor="let q of state.history" [value]="q">
              {{ q }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <button
          mat-stroked-button
          color="primary"
          (click)="loadHistory()"
          [disabled]="!selectedHistory"
        >
          Load
        </button>
        <span class="status" *ngIf="loading">Running…</span>
      </div>
      <div *ngIf="llmInfo" class="info">
        {{ llmInfo }}
        <div class="replacement-list">
          <div *ngFor="let key of llmReplacements | keyvalue">
            {{ key.key }} → {{ key.value }}
          </div>
        </div>
      </div>
      <div *ngIf="error" class="error">{{ error }}</div>
    </section>
  </div>
</div>

<div class="query-editor-container">
  <app-query-results></app-query-results>
</div>
